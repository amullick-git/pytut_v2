<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Adventure: Learn to Code</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script type="module">
        import { tutorialContent } from './tutorial.js';
        window.tutorialContent = tutorialContent;
        
        // Move initialization to after module loads
        window.addEventListener('load', function() {
            initPyodide();
            loadTutorialContent();
        });
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            background-color: #fff;
            border-right: 1px solid #dee2e6;
            height: 100vh;
            position: sticky;
            top: 0;
        }
        .tutorial-section {
            max-height: 800px;
            overflow-y: auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .code-wrapper {
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .code-wrapper:hover .copy-btn {
            opacity: 1;
        }
        .tutorial-section pre {
            background-color: #f1f3f5; /* A light, soft gray */
            color: #212529; /* Dark text for contrast */
            padding: 1rem;
            border-radius: 0.3rem;
            white-space: pre-wrap; /* Wrap long lines */
            border: 1px solid #dee2e6; /* A subtle border */
        }
        .tutorial-section pre code {
            color: #d63384; /* A pleasant pink for code elements */
        }
        #editor {
            width: 100%;
            height: 200px;
            font-family: monospace;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
        }
        #output {
            width: 100%;
            min-height: 100px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .exercise {
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            background-color: #f8f9fa;
        }
        .exercise pre {
            white-space: pre-wrap; /* Allows text to wrap */
            word-wrap: break-word; /* Breaks long words if necessary */
        }
        .chapter-nav {
            margin-bottom: 20px;
        }
        .exercises-list .btn.active {
            background-color: #0d6efd;
            color: white;
        }
        .hint-container {
            background-color: #eef2f7; /* A softer blue */
            border-left: 5px solid #0d6efd; /* A prominent left border */
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            display: flex; /* Use flexbox for alignment */
            align-items: center;
            gap: 10px; /* Space between icon and text */
        }
        .hint-container i {
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar p-0">
                <div class="position-sticky">
                    <h4 class="px-3 pt-3">Chapters</h4>
                    <div id="chapter-list" class="list-group list-group-flush">
                        <!-- Chapter links will be loaded here -->
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Python Adventure: Learn to Code</h1>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="tutorial-section" id="tutorial">
                            <!-- Tutorial content loads here -->
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="exercise-section">
                            <h3>Exercises</h3>
                            <div class="exercises-list mb-3">
                                <!-- Exercise selection buttons load here -->
                                <p>Select a chapter from the sidebar to see its exercises.</p>
                            </div>
                            <div id="current-exercise-content" class="exercise" style="display: none;">
                                <!-- Exercise description loads here -->
                            </div>
                            <div id="hint-section" style="display: none;">
                                <button class="btn btn-info mt-2" onclick="showHint()">Show Hint</button>
                                <div id="hint-box" class="hint-container" style="display: none;">
                                    <i class="bi bi-lightbulb-fill"></i>
                                    <span id="hint-text"></span>
                                </div>
                            </div>
                        </div>

                        <div id="coding-section" class="coding-section mt-4">
                            <h3>Code Playground</h3>
                            <textarea id="editor" placeholder="Try some python code here ..."></textarea>
                            <div class="mb-2">
                                <button class="btn btn-primary" onclick="runCode()">Run Code</button>
                                <button id="btn-check-exercise" class="btn btn-warning" onclick="checkExercise()" style="display: none;">Check Exercise</button>
                                <button id="btn-next-exercise" class="btn btn-success" onclick="loadNextExercise()" style="display: none;">Next Exercise</button>
                            </div>
                            <div id="output"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let pyodide = null;
        let currentChapter = 'chapter1';
        let currentExercise = null;

        async function initPyodide() {
            pyodide = await loadPyodide();
            document.getElementById('output').textContent = 'Python environment ready!';
        }

        function getProgress() {
            const progress = localStorage.getItem('pythonAdventureProgress');
            return progress ? JSON.parse(progress) : {};
        }

        function saveProgress(chapterId, exerciseId) {
            const progress = getProgress();
            if (!progress[chapterId]) {
                progress[chapterId] = [];
            }
            if (!progress[chapterId].includes(exerciseId)) {
                progress[chapterId].push(exerciseId);
            }
            localStorage.setItem('pythonAdventureProgress', JSON.stringify(progress));
        }

        function updateChapterMarker(chapterId) {
            const chapterLink = document.getElementById(`ch-btn-${chapterId}`);
            if (!chapterLink) return;

            const chapter = tutorialContent[chapterId];
            const progress = getProgress();
            const completedCount = (progress[chapterId] || []).length;
            const totalCount = chapter.exercises ? chapter.exercises.length : 0;

            let marker = '';
            if (totalCount > 0) {
                if (completedCount === totalCount) {
                    marker = '‚úÖ '; // All done
                } else if (completedCount > 0) {
                    marker = '‚úèÔ∏è '; // In progress
                }
            }
            chapterLink.innerHTML = marker + chapter.title;
        }

        function highlightActiveChapter(chapterId) {
            document.querySelectorAll('#chapter-list .list-group-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`ch-btn-${chapterId}`).classList.add('active');
        }

        function loadChapter(chapterId) {
            currentChapter = chapterId;
            const chapter = tutorialContent[chapterId];
            document.getElementById('tutorial').innerHTML = chapter.content;

            // Add copy buttons to all <pre> blocks in the tutorial section
            document.querySelectorAll('.tutorial-section pre').forEach(pre => {
                const wrapper = document.createElement('div');
                wrapper.className = 'code-wrapper';

                const copyButton = document.createElement('button');
                copyButton.className = 'btn btn-sm btn-secondary copy-btn';
                copyButton.innerHTML = '<i class="bi bi-clipboard"></i>';
                copyButton.title = 'Copy to clipboard';
                copyButton.onclick = (e) => copyCodeToClipboard(e, pre);

                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(pre);
                wrapper.appendChild(copyButton);
            });
            
            // Load exercise buttons
            const exercisesListDiv = document.querySelector('.exercises-list');
            if (chapter.exercises && chapter.exercises.length > 0) {
                exercisesListDiv.innerHTML = `<button class="btn btn-success" onclick="startExercises()">Start Exercises</button>`;
            } else {
                exercisesListDiv.innerHTML = `<p>No exercises for this chapter.</p>`;
            }

            // Reset exercise view
            document.getElementById('current-exercise-content').style.display = 'none';
            document.getElementById('output').textContent = '';
            currentExercise = null;
            document.getElementById('btn-next-exercise').style.display = 'none';
            document.getElementById('btn-check-exercise').style.display = 'none';
            document.getElementById('hint-section').style.display = 'none';
        }

        function startExercises() {
            const chapter = tutorialContent[currentChapter];
            if (!chapter.exercises || chapter.exercises.length === 0) return;

            const progress = getProgress();
            const completedExercises = progress[currentChapter] || [];

            // Replace "Start" button with the list of exercise buttons
            const exercisesListDiv = document.querySelector('.exercises-list');
            exercisesListDiv.innerHTML = chapter.exercises.map(ex => {
                const isDone = completedExercises.includes(ex.id);
                const doneMarker = isDone ? '‚úÖ ' : '';
                return `<button class="btn btn-outline-primary m-1" id="btn-ex-${ex.id}" onclick="loadExercise('${ex.id}')">${doneMarker}${ex.title}</button>`;
            }).join('');

            // Automatically load the first exercise
            loadExercise(chapter.exercises[0].id);
        }

        function loadExercise(exerciseId) {
            const chapter = tutorialContent[currentChapter];
            currentExercise = chapter.exercises.find(ex => ex.id === exerciseId);
            
            // Show and populate the exercise content area
            const exerciseContentDiv = document.getElementById('current-exercise-content');
            exerciseContentDiv.style.display = 'block';
            exerciseContentDiv.innerHTML = `
                <h4>${currentExercise.title}</h4>
                <div>${currentExercise.description}</div>
            `;
            document.getElementById('editor').value = currentExercise.starter_code || '';
            document.getElementById('output').textContent = '';

            // Show exercise-specific buttons
            document.getElementById('btn-check-exercise').style.display = 'inline-block';

            // Show hint section if a hint exists, but hide the hint box itself
            const hintSection = document.getElementById('hint-section');
            if (currentExercise.hint) {
                hintSection.style.display = 'block';
                document.getElementById('hint-box').style.display = 'none';
                document.getElementById('hint-text').textContent = '';
            } else {
                hintSection.style.display = 'none';
            }

            // Update active button
            document.querySelectorAll('.exercises-list .btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-ex-${exerciseId}`).classList.add('active');

            // Add 'in-progress' marker (‚úèÔ∏è)
            document.querySelectorAll('.exercises-list .btn').forEach(btn => {
                // Remove marker from all buttons first
                btn.innerHTML = btn.innerHTML.replace('‚úèÔ∏è ', '');
            });
            const currentButton = document.getElementById(`btn-ex-${exerciseId}`);
            if (currentButton && !currentButton.innerHTML.includes('‚úÖ')) {
                currentButton.innerHTML = '‚úèÔ∏è ' + currentButton.innerHTML;
            }

            // Show/hide the 'Next Exercise' button
            const nextButton = document.getElementById('btn-next-exercise');
            const exercises = chapter.exercises;
            const currentIndex = exercises.findIndex(ex => ex.id === currentExercise.id);
            if (currentIndex !== -1 && currentIndex < exercises.length - 1) {
                nextButton.style.display = 'inline-block';
            } else {
                nextButton.style.display = 'none';
            }
        }

        function loadNextExercise() {
            if (!currentChapter || !currentExercise) {
                alert("Please select an exercise first.");
                return;
            }

            const chapter = tutorialContent[currentChapter];
            const exercises = chapter.exercises;
            const currentIndex = exercises.findIndex(ex => ex.id === currentExercise.id);

            if (currentIndex !== -1 && currentIndex < exercises.length - 1) {
                // Load the next exercise in the current chapter
                const nextExercise = exercises[currentIndex + 1];
                loadExercise(nextExercise.id);
            } else {
                alert("You've reached the last exercise of this chapter!");
            }
        }

        function showHint() {
            if (currentExercise && currentExercise.hint) {
                const hintBox = document.getElementById('hint-box');
                const hintText = document.getElementById('hint-text');
                // Toggle hint visibility
                if (hintBox.style.display === 'none') {
                    hintText.textContent = currentExercise.hint;
                    hintBox.style.display = 'flex';
                } else {
                    hintBox.style.display = 'none';
                }
            }
        }

        function copyCodeToClipboard(event, preElement) {
            const button = event.currentTarget;
            const code = preElement.querySelector('code')?.innerText || preElement.innerText;
            navigator.clipboard.writeText(code).then(() => {
                button.innerHTML = '<i class="bi bi-check-lg"></i>';
                button.title = 'Copied!';
                setTimeout(() => {
                    button.innerHTML = '<i class="bi bi-clipboard"></i>';
                    button.title = 'Copy to clipboard';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code', err);
            });
        }

        async function runCode() {
            if (!pyodide) return;
            const code = document.getElementById('editor').value;
            let output = '';
            
            try {
                pyodide.runPython(`
                    import io, sys
                    sys.stdout = io.StringIO()
                `);
                
                await pyodide.runPythonAsync(code);
                output = pyodide.runPython("sys.stdout.getvalue()");
            } catch (error) {
                output = 'Error: ' + error.message;
            }
            
            document.getElementById('output').textContent = output;
            return output;
        }

        async function checkExercise() {
            if (!currentExercise) {
                alert('Please select an exercise first!');
                return;
            }
            
            const userCode = document.getElementById('editor').value;
            const userOutput = await runCode();
            const expectedOutput = await runSolution(currentExercise.solution);

            let feedback = [];
            let allChecksPassed = true;

            // 1. Check the final output
            if (userOutput.trim() === expectedOutput.trim()) {
                feedback.push('‚úÖ Output is correct!');
            } else {
                feedback.push('‚ùå Output is incorrect.');
                allChecksPassed = false;
            }

            // 2. Run custom validation checks if they exist
            if (currentExercise.validation) {
                for (const check of currentExercise.validation) { // Use for...of to handle async
                    if (check.type === 'code_contains' && !userCode.includes(check.value)) {
                        feedback.push(check.message);
                        allChecksPassed = false;
                    }
                    if (check.type === 'ast_check') {
                        const { passed, message } = await runAstCheck(userCode, check.script);
                        if (!passed) {
                            feedback.push(message);
                            allChecksPassed = false;
                        }
                    }
                }
            }
            
            let summaryMessage = '';
            if(allChecksPassed) {
                summaryMessage = '\n\nüéâ Great job! All checks passed!';
                saveProgress(currentChapter, currentExercise.id);
                const button = document.getElementById(`btn-ex-${currentExercise.id}`);
                if (button) {
                    button.innerHTML = button.innerHTML.replace('‚úèÔ∏è ', '');
                    if (!button.innerHTML.includes('‚úÖ')) {
                        button.innerHTML = '‚úÖ ' + button.innerHTML;
                    }
                }
                updateChapterMarker(currentChapter); // Update chapter status in sidebar
            } else {
                summaryMessage = '\n\nü§î Not quite there yet. Review the feedback below and try again!';
            }

            const detailedFeedback = '\n\n--- CHECK RESULTS ---\n' + feedback.join('\n');
            
            // Prepend the summary and then add the detailed feedback
            document.getElementById('output').textContent += summaryMessage + detailedFeedback;
        }

        async function runSolution(solution) {
            pyodide.runPython(`
                import io, sys
                sys.stdout = io.StringIO()
            `);
            await pyodide.runPythonAsync(solution);
            return pyodide.runPython("sys.stdout.getvalue()");
        }

        async function runAstCheck(userCode, checkScript) {
            try {
                // Pass user's code to pyodide as a global variable
                pyodide.globals.set("user_code_to_check", userCode);
                
                // The checkScript will use the global 'user_code_to_check' variable
                const fullScript = `
import ast
import json

user_code = user_code_to_check

${checkScript}

# The check function is expected to be defined in the script and return (bool, str)
result_passed, result_message = check() 
json.dumps((result_passed, result_message))
`;
                const resultJson = await pyodide.runPythonAsync(fullScript);
                const [passed, message] = JSON.parse(resultJson);
                return { passed, message };
            } catch (error) {
                console.error("AST Check failed:", error);
                return { passed: false, message: "‚ö†Ô∏è Error running validation check." };
            }
        }

        function loadTutorialContent() {
            const tutorialDiv = document.getElementById('tutorial');
            // Load initial content showing book introduction
            tutorialDiv.innerHTML = `
                <h2>Python Adventure: Learn to Code (Ages ~9‚Äì11)</h2>
                <p>A story‚Äëdriven, hands‚Äëon journey through Python for curious kids! Each chapter mixes storytelling, step‚Äëby‚Äëstep explanations, fun examples, and challenges. Every topic comes alive with colorful analogies and creative exercises.</p>
                
                <h3>How to Use This Book</h3>
                <ul>
                    <li><strong>Work a little each day</strong> (20‚Äì30 minutes is perfect).</li>
                    <li><strong>Type every example</strong> ‚Äî that's how you learn!</li>
                    <li><strong>Try before looking at answers.</strong></li>
                    <li><strong>Earn badges</strong> for finishing chapters.</li>
                    <li><strong>Ask questions!</strong> Python loves curious minds.</li>
                </ul>

                <h3>Choose a chapter to begin!</h3>
            `;

            // Dynamically load chapters into the sidebar
            const chapterList = document.getElementById('chapter-list');
            const progress = getProgress();
            chapterList.innerHTML = Object.keys(tutorialContent).map(key => {
                const chapter = tutorialContent[key];
                // Create the link with the title already inside
                return `<a href="#" id="ch-btn-${key}" class="list-group-item list-group-item-action" onclick="loadChapter('${key}'); highlightActiveChapter('${key}');">${chapter.title}</a>`;
            }).join('');

            // Now that the links exist, update their markers
            Object.keys(tutorialContent).forEach(updateChapterMarker);

            // Load chapter 1 by default
            loadChapter('chapter1');
            highlightActiveChapter('chapter1');
        }
    </script>
</body>
</html>
