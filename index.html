<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Adventure: Learn to Code</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script type="module">
        import { tutorialContent } from './tutorial.js';
        window.tutorialContent = tutorialContent;
        
        // Move initialization to after module loads
        window.addEventListener('load', function() {
            initPyodide();
            loadTutorialContent();
        });
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- CodeMirror for line numbers and syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/neat.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/python/python.min.js"></script>


    <style>
        body {
            background-color: #f8f9fa;
        }
        main {
            background-color: #f0f2f5; /* A slightly darker, neutral background for the main area */
            padding-top: 1.5rem !important;
        }
        .sidebar {
            background-color: #fbfdff; /* Softer, slightly cool off-white */
            border-right: 1px solid #dee2e6;
            height: 100vh;
            position: sticky;
            top: 0;
        }
        .chapter-container {
            border-bottom: 1px solid #dee2e6; /* Divider line */
        }
        .sidebar h4 {
            font-weight: 600;
            color: #495057;
            letter-spacing: 0.5px;
        }
        #chapter-list .list-group-item {
            font-weight: 500; /* Medium weight for chapter titles */
            color: #343a40;
            border: none; /* Remove default borders */
            padding: 0.85rem 1.5rem; /* More vertical and horizontal space */
            transition: background-color 0.2s ease-in-out;
        }
        #chapter-list .list-group-item.active {
            background-color: #e7f5ff; /* Light blue background for active */
            color: #0c63e4;
            font-weight: 600; /* Bolder when active */
            border-left: 4px solid #0c63e4; /* Accent border */
            padding-left: calc(1.5rem - 4px); /* Adjust padding to align text */
        }
        #chapter-list .list-group-item:not(.active):hover {
            background-color: #f1f3f5; /* Subtle hover for non-active items */
        }
        .sidebar .bi { /* Style for progress icons */
            margin-right: 8px;
            font-size: 0.9em;
            vertical-align: middle;
            position: relative;
            top: -1px;
        }
        .tutorial-section {
            max-height: 800px;
            overflow-y: auto; /* Keep scrolling for long content */
            padding: 2rem;
            background-color: #fff;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .code-wrapper {
            position: relative;
        }
        .code-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            display: flex;
            gap: 0.5rem;
        }
        .code-wrapper:hover .code-actions {
            opacity: 1;
        }
        .tutorial-section pre {
            background-color: #f1f3f5; /* A light, soft gray */
            color: #212529; /* Dark text for contrast */
            padding: 1rem;
            border-radius: 0.3rem;
            white-space: pre-wrap; /* Wrap long lines */
            border: 1px solid #dee2e6; /* A subtle border */
        }
        .tutorial-section pre code {
            color: #d63384; /* A pleasant pink for code elements */
        }
        /* CodeMirror styling */
        .CodeMirror {
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #output {
            width: 100%;
            min-height: 100px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: monospace;
            white-space: pre-wrap;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .exercise {
            padding: 1.5rem;
            margin-top: 1rem;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .exercise pre {
            white-space: pre-wrap; /* Allows text to wrap */
            word-wrap: break-word; /* Breaks long words if necessary */
        }
        .interactive-zone {
            background-color: #fbfdff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .exercises-list .btn {
            border-radius: 20px; /* Pill-shaped buttons */
            font-weight: 500;
        }
        .exercises-list .btn.active {
            background-color: #0d6efd;
            color: white;
            box-shadow: 0 2px 4px rgba(13,110,253,0.3);
        }
        .chapter-nav {
            margin-bottom: 20px;
        }
        .exercises-list .btn.active {
            background-color: #0d6efd;
            color: white;
        }
        .hint-container {
            background-color: #eef2f7; /* A softer blue */
            border-left: 5px solid #0d6efd; /* A prominent left border */
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            display: flex; /* Use flexbox for alignment */
            align-items: center;
            gap: 10px; /* Space between icon and text */
        }
        .hint-container i {
            font-size: 1.2rem;
        }
        #section-list .list-group-item {
            border: none;
        }
        .section-list-for-chapter .list-group-item {
            padding-top: 0.3rem; /* Reduced vertical padding */
            padding-bottom: 0.3rem; /* Reduced vertical padding */
            padding-left: 2.5rem; /* Indent section links */
            font-size: 0.9rem;
            color: #495057; /* Slightly lighter text for sections */
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar p-0">
                <div class="position-sticky">
                    <h4 class="px-3 pt-3">Chapters</h4>
                    <div id="chapter-list" class="list-group list-group-flush">
                        <!-- Chapter links will be loaded here -->
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Python Adventure: Learn to Code</h1>
                </div>

                <!-- Tutorial Content Area -->
                <div class="tutorial-section" id="tutorial">
                    <!-- Tutorial content loads here -->
                </div>
                
                <!-- Interactive Zone for Exercises and Code -->
                <div class="interactive-zone">
                    <div class="row">
                        <div class="col-lg-6">
                            <h3>Exercises</h3>
                            <div class="exercises-list mb-3">
                                <!-- Exercise selection buttons load here -->
                                <p>Select a chapter from the sidebar to see its exercises.</p>
                            </div>
                            <div id="current-exercise-content" class="exercise" style="display: none;">
                                <!-- Exercise description loads here -->
                            </div>
                        </div>
                        <div class="col-lg-6 mt-4 mt-lg-0">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h3>Code Playground</h3>
                                <!-- The hint button will be part of the hint-section div below -->
                                <button id="btn-hint" class="btn btn-warning" onclick="showHint()" style="display: none;"><i class="bi bi-lightbulb"></i> Hint</button>
                            </div>
                            <div id="hint-section" style="display: none;">
                                <div id="hint-box" class="hint-container mb-2" style="display: none;">
                                    <i class="bi bi-lightbulb-fill"></i>
                                    <span id="hint-text"></span>
                                </div>
                            </div>
                            <textarea id="editor" placeholder="Try some python code here ..."></textarea>
                            <div class="d-flex mb-2">
                                <button class="btn btn-primary" onclick="runCode()">Run Code</button>
                                <button id="btn-check-exercise" class="btn btn-info" onclick="checkExercise()" style="display: none;">Check Exercise</button>
                                <button id="btn-reset-code" class="btn btn-outline-danger" onclick="resetCode()" style="display: none;"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
                                <button id="btn-next-exercise" class="btn btn-success ms-auto" onclick="loadNextExercise()" style="display: none;">Next Exercise</button>
                            </div>
                            <div id="output"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div class="modal fade" id="resetConfirmModal" tabindex="-1" aria-labelledby="resetConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetConfirmModalLabel">Confirm Reset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to reset your code? Your current work on this exercise will be lost.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmResetBtn">Reset Code</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let pyodide = null;
        let currentChapter = 'chapter1';
        let codeEditor = null; // To hold the CodeMirror instance
        let currentExercise = null;

        async function initPyodide() {
            pyodide = await loadPyodide();
            document.getElementById('output').textContent = 'Python environment ready!';
        }

        function getProgress() {
            const progress = localStorage.getItem('pythonAdventureProgress');
            return progress ? JSON.parse(progress) : {};
        }

        function saveProgress(chapterId, exerciseId) {
            const progress = getProgress();
            if (!progress[chapterId]) {
                progress[chapterId] = [];
            }
            if (!progress[chapterId].includes(exerciseId)) {
                progress[chapterId].push(exerciseId);
            }
            localStorage.setItem('pythonAdventureProgress', JSON.stringify(progress));
        }

        function saveCodeForExercise(chapterId, exerciseId, code) {
            if (!chapterId || !exerciseId || !currentExercise) return;
            const key = `code-${chapterId}-${exerciseId}`;
            const dataToSave = {
                code: code,
                version: currentExercise.version || 1 // Save code with its version
            };
            localStorage.setItem(key, JSON.stringify(dataToSave));
        }

        function getSavedCodeForExercise(chapterId, exerciseId) {
            if (!chapterId || !exerciseId || !currentExercise) return null;
            const key = `code-${chapterId}-${exerciseId}`;
            const savedData = localStorage.getItem(key);
            if (!savedData) return null;

            const parsedData = JSON.parse(savedData);
            // If saved version matches current exercise version, return the code.
            if (parsedData.version === currentExercise.version) {
                return parsedData.code;
            }
            return null; // Otherwise, discard saved code.
        }

        function updateChapterMarker(chapterId) {
            const chapterLink = document.getElementById(`ch-btn-${chapterId}`);
            if (!chapterLink) return;

            const chapter = tutorialContent[chapterId];
            const progress = getProgress();
            const completedCount = (progress[chapterId] || []).length;
            const totalCount = chapter.exercises ? chapter.exercises.length : 0;

            let marker = '';
            if (totalCount > 0) {
                 if (completedCount === totalCount) {
                    marker = '<i class="bi bi-check-circle-fill text-success"></i>'; // All done
                 } else if (completedCount > 0) {
                    marker = '<i class="bi bi-pencil-fill text-primary"></i>'; // In progress
                 }
            }
            chapterLink.innerHTML = marker + chapter.title;
        }

        function highlightActiveChapter(chapterId) {
            document.querySelectorAll('#chapter-list .list-group-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`ch-btn-${chapterId}`).classList.add('active');
        }

        function loadChapter(chapterId) {
            // Save code from the current exercise before switching chapters
            if (currentChapter && currentExercise && codeEditor) {
                const code = codeEditor.getValue();
                saveCodeForExercise(currentChapter, currentExercise.id, code);
            }

            currentChapter = chapterId;
            localStorage.setItem('lastChapter', chapterId); // Save chapter
            localStorage.removeItem('lastExercise'); // Clear last exercise
            const chapter = tutorialContent[chapterId];

            let chapterHtml = '';
            // Check for the new structure (story + sections)
            if (chapter.story && chapter.sections) {
                chapterHtml += chapter.story;
                chapter.sections.forEach((section, index) => {
                    // Give each section an ID so we can link to it
                    const sectionId = `section-${index}`;
                    if (index > 0) {
                        chapterHtml += '<hr class="my-4">'; // Add a separator between sections
                    }
                    chapterHtml += `<h3 id="${sectionId}">${section.title}</h3><div>${section.content}</div>`;
                });
            } else { // Fallback to the old structure (single content property)
                chapterHtml = chapter.content;
            }
            document.getElementById('tutorial').innerHTML = chapterHtml;

            // Add copy buttons to all <pre> blocks in the tutorial section
            document.querySelectorAll('.tutorial-section pre').forEach(pre => {
                const wrapper = document.createElement('div');
                wrapper.className = 'code-wrapper';

                const actionsWrapper = document.createElement('div');
                actionsWrapper.className = 'code-actions';

                const tryButton = document.createElement('button');
                tryButton.className = 'btn btn-sm btn-primary';
                tryButton.innerHTML = '<i class="bi bi-play-circle"></i> Try It';
                tryButton.title = 'Send to Playground';
                tryButton.onclick = (e) => sendToPlayground(pre);

                const copyButton = document.createElement('button');
                copyButton.className = 'btn btn-sm btn-secondary';
                copyButton.innerHTML = '<i class="bi bi-clipboard"></i>';
                copyButton.title = 'Copy to clipboard';
                copyButton.onclick = (e) => copyCodeToClipboard(e, pre);

                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(pre);
                actionsWrapper.appendChild(tryButton);
                actionsWrapper.appendChild(copyButton);
                wrapper.appendChild(actionsWrapper);
            });
            
            // Load exercise and section lists
            // First, hide all section lists
            document.querySelectorAll('.section-list-for-chapter').forEach(list => {
                list.style.display = 'none';
                list.innerHTML = '';
            });

            const exercisesListDiv = document.querySelector('.exercises-list');
            if (chapter.exercises && chapter.exercises.length > 0) {
                exercisesListDiv.innerHTML = `<button class="btn btn-success" onclick="startExercises()">Start Exercises</button>`;
            } else {
                exercisesListDiv.innerHTML = `<p>No exercises for this chapter.</p>`;
            }

            // Populate and show the section list for the CURRENT chapter
            if (chapter.sections && chapter.sections.length > 0) {
                const sectionListContainer = document.getElementById(`sections-for-${chapterId}`);
                sectionListContainer.style.display = 'block';
                chapter.sections.forEach((section, index) => {
                    const sectionId = `section-${index}`;
                    const link = document.createElement('a');
                    link.href = `#${sectionId}`;
                    link.className = 'list-group-item list-group-item-action border-0'; // border-0 for cleaner look
                    link.innerHTML = section.title.replace(/<[^>]*>/g, '').replace(/(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/g, '').trim();
                    sectionListContainer.appendChild(link);
                });
            }

            // Reset exercise view
            document.getElementById('current-exercise-content').style.display = 'none';
            document.getElementById('output').textContent = '';
            currentExercise = null;
            document.getElementById('btn-next-exercise').style.display = 'none';
            document.getElementById('btn-check-exercise').style.display = 'none';
            document.getElementById('btn-reset-code').style.display = 'none';
            document.getElementById('hint-section').style.display = 'none';
        }

        function startExercises() {
            const chapter = tutorialContent[currentChapter];
            if (!chapter.exercises || chapter.exercises.length === 0) return;

            const progress = getProgress();
            const completedExercises = progress[currentChapter] || [];

            // Replace "Start" button with the list of exercise buttons
            const exercisesListDiv = document.querySelector('.exercises-list');
            exercisesListDiv.innerHTML = chapter.exercises.map(ex => {
                const isDone = completedExercises.includes(ex.id);
                const doneMarker = isDone ? 'âœ… ' : '';
                return `<button class="btn btn-outline-primary m-1" id="btn-ex-${ex.id}" onclick="loadExercise('${ex.id}')">${doneMarker}${ex.title}</button>`;
            }).join('');

            // Automatically load the first exercise
            loadExercise(chapter.exercises[0].id);
        }

        function loadExercise(exerciseId) {
            // Save code from the previous exercise before loading the new one
            if (currentChapter && currentExercise && codeEditor) {
                const code = codeEditor.getValue();
                saveCodeForExercise(currentChapter, currentExercise.id, code);
            }

            const chapter = tutorialContent[currentChapter];
            currentExercise = chapter.exercises.find(ex => ex.id === exerciseId);
            localStorage.setItem('lastExercise', exerciseId); // Save exercise
            
            // Show and populate the exercise content area
            const exerciseContentDiv = document.getElementById('current-exercise-content');
            exerciseContentDiv.style.display = 'block';
            exerciseContentDiv.innerHTML = `
                <h4>${currentExercise.title}</h4>
                <div>${currentExercise.description}</div>
            `;

            const savedCode = getSavedCodeForExercise(currentChapter, exerciseId);
            codeEditor.setValue(savedCode || currentExercise.starter_code || '');

            document.getElementById('output').textContent = '';

            // Show exercise-specific buttons
            document.getElementById('btn-check-exercise').style.display = 'inline-block';
            document.getElementById('btn-reset-code').style.display = 'inline-block';

            // Show hint section if a hint exists, but hide the hint box itself
            const hintButton = document.getElementById('btn-hint');
            if (currentExercise.hint) {
                hintButton.style.display = 'inline-block';
                document.getElementById('hint-box').style.display = 'none';
                document.getElementById('hint-text').textContent = '';
            } else {
                hintButton.style.display = 'none';
                document.getElementById('hint-box').style.display = 'none'; // Also hide the box
            }

            // Update active button
            document.querySelectorAll('.exercises-list .btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-ex-${exerciseId}`).classList.add('active');

            // Add 'in-progress' marker (âœï¸)
            document.querySelectorAll('.exercises-list .btn').forEach(btn => {
                // Remove marker from all buttons first
                btn.innerHTML = btn.innerHTML.replace('âœï¸ ', '');
            });
            const currentButton = document.getElementById(`btn-ex-${exerciseId}`);
            if (currentButton && !currentButton.innerHTML.includes('âœ…')) {
                currentButton.innerHTML = 'âœï¸ ' + currentButton.innerHTML;
            }

            // Show/hide the 'Next Exercise' button
            const nextButton = document.getElementById('btn-next-exercise');
            const exercises = chapter.exercises;
            const currentIndex = exercises.findIndex(ex => ex.id === currentExercise.id);
            if (currentIndex !== -1 && currentIndex < exercises.length - 1) {
                nextButton.style.display = 'inline-block';
            } else {
                nextButton.style.display = 'none';
            }
        }

        function loadNextExercise() {
            if (!currentChapter || !currentExercise) {
                alert("Please select an exercise first.");
                return;
            }

            const chapter = tutorialContent[currentChapter];
            const exercises = chapter.exercises;
            const currentIndex = exercises.findIndex(ex => ex.id === currentExercise.id);

            if (currentIndex !== -1 && currentIndex < exercises.length - 1) {
                // Load the next exercise in the current chapter
                const nextExercise = exercises[currentIndex + 1];
                loadExercise(nextExercise.id);
            } else {
                alert("You've reached the last exercise of this chapter!");
            }
        }

        function resetCode() {
            if (!currentChapter || !currentExercise) {
                // This case should ideally not be hit if button is hidden correctly
                console.warn("Reset button clicked without an active exercise.");
                return;
            }

            // Show the Bootstrap confirmation modal
            const resetModal = new bootstrap.Modal(document.getElementById('resetConfirmModal'));
            resetModal.show();
            // The actual reset logic is now handled by an event listener on the modal's button
            // to prevent it from running before confirmation.
        }

        function showHint() {
            if (currentExercise && currentExercise.hint) {
                const hintBox = document.getElementById('hint-box');
                const hintText = document.getElementById('hint-text');
                // Toggle hint visibility
                if (hintBox.style.display === 'none') {
                    hintText.textContent = currentExercise.hint;
                    hintBox.parentElement.style.display = 'block'; // Show the container
                    hintBox.style.display = 'flex';
                } else {
                    hintBox.style.display = 'none';
                }
            }
        }

        function sendToPlayground(preElement) {
            const code = preElement.querySelector('code')?.innerText || preElement.innerText;
            codeEditor.setValue(code);

            // Scroll to the editor and give it focus
            codeEditor.getWrapperElement().scrollIntoView({ behavior: 'smooth', block: 'center' });
            codeEditor.focus();
            
            // Flash the editor to provide visual feedback (note: this won't work on CodeMirror directly, but we can style the wrapper)
            editor.style.boxShadow = '0 0 0 2px rgba(13, 110, 253, 0.5)';
            setTimeout(() => {
                editor.style.boxShadow = '';
            }, 500);
        }

        function copyCodeToClipboard(event, preElement) {
            const button = event.currentTarget;
            const code = preElement.querySelector('code')?.innerText || preElement.innerText;
            navigator.clipboard.writeText(code).then(() => {
                button.innerHTML = '<i class="bi bi-check-lg"></i>';
                button.title = 'Copied!';
                setTimeout(() => {
                    button.innerHTML = '<i class="bi bi-clipboard"></i>';
                    button.title = 'Copy to clipboard';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code', err);
            });
        }

        async function runCode() {
            if (!pyodide) return;
            const code = codeEditor.getValue();

            if (currentChapter && currentExercise) {
                saveCodeForExercise(currentChapter, currentExercise.id, code);
            }

            let output = '';
            
            try {
                pyodide.runPython(`
                    import io, sys
                    sys.stdout = io.StringIO()
                `);
                
                await pyodide.runPythonAsync(code);
                output = pyodide.runPython("sys.stdout.getvalue()");
            } catch (error) {
                output = 'Error: ' + error.message;
            }
            
            document.getElementById('output').textContent = output;
            return output;
        }

        async function checkExercise() {
            if (!currentExercise) {
                alert('Please select an exercise first!');
                return;
            }
            
            const userCode = codeEditor.getValue();
            const userOutput = await runCode();
            const expectedOutput = await runSolution(currentExercise.solution);

            let feedback = [];
            let allChecksPassed = true;

            // 1. Check the final output
            if (userOutput.trim() === expectedOutput.trim()) {
                feedback.push('âœ… Output is correct!');
            } else {
                feedback.push('âŒ Output is incorrect.');
                allChecksPassed = false;
            }

            // 2. Run custom validation checks if they exist
            if (currentExercise.validation) {
                for (const check of currentExercise.validation) { // Use for...of to handle async
                    if (check.type === 'code_contains' && !userCode.includes(check.value)) {
                        feedback.push(check.message);
                        allChecksPassed = false;
                    }
                    if (check.type === 'ast_check') {
                        const { passed, message } = await runAstCheck(userCode, check.script);
                        if (!passed) {
                            feedback.push(message);
                            allChecksPassed = false;
                        }
                    }
                    if (check.type === 'output_match_cases') {
                        for (const testCase of check.cases) {
                            const caseResult = await runCodeWithSetup(userCode, testCase.setup_code);
                            if (caseResult.trim() === testCase.expected_output.trim()) {
                                feedback.push(`âœ… ${testCase.name}: Passed`);
                            } else {
                                feedback.push(`âŒ ${testCase.name}: Failed`);
                                feedback.push(`   - Expected: ${JSON.stringify(testCase.expected_output.trim())}`);
                                feedback.push(`   - Got:      ${JSON.stringify(caseResult.trim())}`);
                                allChecksPassed = false;
                            }
                        }
                    }
                }
            }
            
            let summaryMessage = '';
            if(allChecksPassed) {
                summaryMessage = '\n\nðŸŽ‰ Great job! All checks passed!';
                saveProgress(currentChapter, currentExercise.id);
                const button = document.getElementById(`btn-ex-${currentExercise.id}`);
                if (button) {
                    button.innerHTML = button.innerHTML.replace('âœï¸ ', '');
                    if (!button.innerHTML.includes('âœ…')) {
                        button.innerHTML = 'âœ… ' + button.innerHTML;
                    }
                }
                updateChapterMarker(currentChapter); // Update chapter status in sidebar
            } else {
                summaryMessage = '\n\nðŸ¤” Not quite there yet. Review the feedback below and try again!';
            }

            const detailedFeedback = '\n\n--- CHECK RESULTS ---\n' + feedback.join('\n');
            
            // Prepend the summary and then add the detailed feedback
            document.getElementById('output').textContent += summaryMessage + detailedFeedback;
        }

        async function runSolution(solution) {
            pyodide.runPython(`
                import io, sys
                sys.stdout = io.StringIO()
            `);
            await pyodide.runPythonAsync(solution);
            return pyodide.runPython("sys.stdout.getvalue()");
        }

        async function runCodeWithSetup(userCode, setupCode) {
            if (!pyodide) return;
            if (!currentExercise || !currentExercise.starter_code) return userCode; // Failsafe

            let output = '';
            try {
                pyodide.runPython(`
                    import io, sys
                    sys.stdout = io.StringIO()
                `);

                // As you suggested, we remove the original setup from the user's code.
                // We identify the setup part of the starter code (everything before the comment).
                const setupMarker = '# --- DO NOT DELETE: Your code starts below ---';
                const originalSetupLines = currentExercise.starter_code.split(setupMarker)[0].split('\n').filter(line => line.trim() !== '');

                // Filter out those setup lines from the user's submitted code.
                const userLogicOnly = userCode.split('\n').filter(userLine => 
                    !originalSetupLines.some(setupLine => userLine.trim().startsWith(setupLine.split('=')[0].trim()))
                ).join('\n');

                // Prepend the current test case's setup code and run.
                const fullCode = `${setupCode}\n${userLogicOnly}`;
                await pyodide.runPythonAsync(fullCode);
                output = pyodide.runPython("sys.stdout.getvalue()");
            } catch (error) {
                output = 'Error running code: ' + error.message;
            }
            return output;
        }

        async function runAstCheck(userCode, checkScript) {
            try {
                // Pass user's code to pyodide as a global variable
                pyodide.globals.set("user_code_to_check", userCode);
                
                // The checkScript will use the global 'user_code_to_check' variable
                const fullScript = `
import ast
import json

user_code = user_code_to_check

${checkScript}

# The check function is expected to be defined in the script and return (bool, str)
result_passed, result_message = check() 
json.dumps((result_passed, result_message))
`;
                const resultJson = await pyodide.runPythonAsync(fullScript);
                const [passed, message] = JSON.parse(resultJson);
                return { passed, message };
            } catch (error) {
                console.error("AST Check failed:", error);
                return { passed: false, message: "âš ï¸ Error running validation check." };
            }
        }

        function loadTutorialContent() {
            // Dynamically load chapters into the sidebar
            const chapterList = document.getElementById('chapter-list');
            const progress = getProgress();
            chapterList.innerHTML = Object.keys(tutorialContent).map(key => {
                const chapter = tutorialContent[key];
                // Create a container for the chapter link and its future section list
                 return `
                    <div class="chapter-container">
                        <a href="#" id="ch-btn-${key}" class="list-group-item list-group-item-action" onclick="loadChapter('${key}'); highlightActiveChapter('${key}');">${chapter.title}</a>
                        <div id="sections-for-${key}" class="list-group list-group-flush section-list-for-chapter" style="display: none;"></div>
                    </div>`;
            }).join('');

            // Now that the links exist, update their markers
            Object.keys(tutorialContent).forEach(updateChapterMarker);

            // Initialize CodeMirror on the textarea FIRST.
            // This prevents the "Cannot read properties of null (reading 'setValue')" error.
            codeEditor = CodeMirror.fromTextArea(document.getElementById('editor'), {
                lineNumbers: true,
                mode: 'python',
                theme: 'neat',
                indentUnit: 4
            });

            // Load the last visited chapter and exercise
            const lastChapter = localStorage.getItem('lastChapter') || 'chapter1';
            const lastExercise = localStorage.getItem('lastExercise');

            loadChapter(lastChapter);
            highlightActiveChapter(lastChapter);

            // If there was a specific exercise open, load it
            if (lastExercise) {
                startExercises(); // Display the exercise buttons
                loadExercise(lastExercise); // Load the specific exercise
            }
        }

        // Add event listener for the modal's confirm button after the DOM is loaded
        document.addEventListener('DOMContentLoaded', (event) => {
            const confirmResetButton = document.getElementById('confirmResetBtn');
            if (confirmResetButton) {
                confirmResetButton.addEventListener('click', () => {
                    if (currentChapter && currentExercise) {
                        const key = `code-${currentChapter}-${currentExercise.id}`;
                        localStorage.removeItem(key);
                        codeEditor.setValue(currentExercise.starter_code || '');
                    }
                    // Hide the modal after action
                    const resetModal = bootstrap.Modal.getInstance(document.getElementById('resetConfirmModal'));
                    resetModal.hide();
                });
            }
        });
    </script>
</body>
</html>
